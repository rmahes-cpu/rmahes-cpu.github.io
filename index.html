<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1, viewport-fit=cover" />
  <title>Darts Scoreboard</title>
  <style>
    :root{
      --bg:#f6f8ff;
      --bg2:#ffffff;
      --ink:#0b1020;
      --muted:#44506f;
      --line:rgba(10,20,40,.12);

      --good:#10b981;
      --bad:#ef4444;
      --warn:#f59e0b;

      --ringRed:#e11d48;
      --ringGreen:#16a34a;
    }

    *{box-sizing:border-box}
    html, body{
      height:100%;
      margin:0;
      background: linear-gradient(180deg, var(--bg), var(--bg2));
      color: var(--ink);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, sans-serif;
    }

    /* ‚úÖ Always visible top bar */
    header{
      height:56px;
      padding: 10px 12px;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      border-bottom:1px solid var(--line);
      background: rgba(255,255,255,.90);
      backdrop-filter: blur(10px);
      position: fixed;
      top:0; left:0; right:0;
      z-index: 9999;
    }

    .brand{display:flex; align-items:center; gap:10px; user-select:none}
    .logo{
      width:34px; height:34px; border-radius:12px;
      background:
        radial-gradient(circle at 35% 30%, rgba(255,255,255,.65), transparent 55%),
        conic-gradient(from 210deg, var(--ringGreen), #f9fafb, var(--ringRed), #f9fafb, var(--ringGreen));
      border:1px solid rgba(10,20,40,.14);
      box-shadow: 0 12px 30px rgba(10,20,40,.10);
    }
    header h1{margin:0; font-size:14px; letter-spacing:.6px; font-weight:950}
    header h1 span{opacity:.75; font-weight:800}
    .btns{display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end}

    button, input, select{font:inherit}
    button{
      border:1px solid rgba(10,20,40,.14);
      color: var(--ink);
      background: linear-gradient(180deg, rgba(255,255,255,.95), rgba(245,248,255,.92));
      padding:10px 12px;
      border-radius: 14px;
      cursor:pointer;
      touch-action: manipulation;
    }
    button:hover{border-color: rgba(0,119,255,.45)}
    button.primary{
      color:#fff;
      background: linear-gradient(180deg, rgba(0,119,255,.95), rgba(11,60,255,.95));
      border-color: rgba(0,119,255,.65);
      box-shadow: 0 14px 40px rgba(0,119,255,.18);
    }
    button.danger{
      color:#fff;
      background: linear-gradient(180deg, rgba(239,68,68,.95), rgba(225,29,72,.92));
      border-color: rgba(239,68,68,.55);
    }
    button:disabled{opacity:.55; cursor:not-allowed}

    /* ‚úÖ main pushed below fixed header */
    main{
      height: calc(100% - 56px);
      padding: 66px 10px 10px;
      max-width: 1200px;
      margin: 0 auto;
      overflow: visible;
    }

    .grid{display:grid; gap:12px}
    @media (min-width:980px){
      .grid.cols2{grid-template-columns: 1.25fr .75fr}
      .grid.cols3{grid-template-columns: 1fr 1fr 1fr}
    }

    .card{
      border-radius: 20px;
      border:1px solid var(--line);
      background:
        radial-gradient(900px 280px at 30% -10%, rgba(0,181,255,.10), transparent 60%),
        linear-gradient(180deg, rgba(255,255,255,.95), rgba(245,248,255,.92));
      box-shadow: 0 18px 55px rgba(10,20,40,.08);
      padding: 14px;
    }
    .card h2{
      margin:0 0 10px;
      font-size:12px;
      color: var(--muted);
      font-weight:950;
      letter-spacing:.35px;
      text-transform: uppercase;
    }

    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
    .row.between{justify-content:space-between}
    .divider{height:1px; background: rgba(10,20,40,.10); margin: 10px 0}

    .field{display:flex; flex-direction:column; gap:6px; min-width:160px}
    .field label{font-size:12px; color: var(--muted); font-weight:800}
    input, select{
      background: rgba(255,255,255,.95);
      border:1px solid rgba(10,20,40,.14);
      color: var(--ink);
      border-radius: 14px;
      padding: 12px 12px;
      outline: none;
    }
    input:focus, select:focus{border-color: rgba(0,119,255,.55); box-shadow: 0 0 0 3px rgba(0,119,255,.12)}

    .hint{color: var(--muted); font-size:12px; line-height:1.45}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace}

    .setupWrap{height:100%; overflow:auto; -webkit-overflow-scrolling: touch; padding-bottom: 12px;}

    .swipeShell{height:100%; display:flex; flex-direction:column; gap:10px; overflow:hidden;}
    .swipeHint{display:flex; align-items:center; justify-content:space-between; gap:10px;}
    .chip{
      display:inline-flex; align-items:center; gap:8px;
      padding: 7px 10px;
      border-radius: 999px;
      border:1px solid rgba(10,20,40,.12);
      background: rgba(255,255,255,.85);
      color: var(--muted);
      font-size:12px;
      font-weight:900;
      letter-spacing:.35px;
      white-space:nowrap;
    }
    .dots{display:flex; gap:7px; align-items:center}
    .dot{width:8px; height:8px; border-radius:999px; border:1px solid rgba(10,20,40,.18); background: rgba(10,20,40,.08);}
    .dot.active{ background: rgba(0,119,255,.35); border-color: rgba(0,119,255,.55); }

    .swipeWrap{
      flex: 1;
      display:flex;
      gap:12px;
      overflow-x:auto;
      overflow-y:hidden;
      scroll-snap-type: x mandatory;
      -webkit-overflow-scrolling: touch;
      border-radius: 20px;
    }
    .swipePanel{
      min-width: 100%;
      scroll-snap-align: start;
      height:100%;
      display:flex;
      flex-direction:column;
      gap:12px;
      overflow: hidden;
    }

    @media (min-width: 980px){
      main{ height:auto; min-height: calc(100vh - 56px); overflow: visible; }
      .swipeShell{ height:auto; overflow: visible; }
      .swipeWrap{
        overflow: visible;
        scroll-snap-type:none;
        display:grid;
        grid-template-columns: 1fr 1.25fr 1fr;
      }
      .swipePanel{ min-width:auto; height:auto; overflow: visible; }
    }

    .playerRow{display:grid; grid-template-columns: 1fr 1fr; gap:10px; align-items:stretch;}
    .playerMini{
      border-radius: 16px;
      border:1px solid rgba(10,20,40,.12);
      overflow:hidden;
      background:#fff;
      box-shadow: 0 12px 30px rgba(10,20,40,.08);
      min-width: 0;
    }
    .miniTop{
      display:flex; justify-content:space-between; align-items:center; gap:8px;
      padding: 8px 10px;
      color:#fff;
      background: linear-gradient(90deg, rgba(11,60,255,.95), rgba(0,181,255,.85));
    }
    .miniName{
      font-weight:1000;
      letter-spacing:.2px;
      font-size: 12.5px;
      overflow:hidden; text-overflow:ellipsis; white-space:nowrap;
      max-width: 56vw;
    }
    .miniName span{
      font-weight:950;
      opacity:.92;
      font-size: 11px;
      margin-left: 6px;
    }
    .turnPill{
      display:inline-flex; align-items:center; gap:7px;
      padding: 5px 8px; border-radius:999px;
      background: rgba(0,0,0,.22);
      border:1px solid rgba(255,255,255,.25);
      font-size:10px; font-weight:1000; letter-spacing:.6px;
      min-width: 62px; justify-content:center;
      flex: 0 0 auto;
    }
    .turnDot{
      width:7px; height:7px; border-radius:999px;
      background: var(--ringGreen);
      box-shadow: 0 0 0 3px rgba(22,163,74,.20);
    }
    .miniBody{
      padding: 8px 10px 10px;
      background:
        radial-gradient(700px 220px at 10% 0%, rgba(225,29,72,.06), transparent 60%),
        radial-gradient(700px 220px at 90% 10%, rgba(22,163,74,.06), transparent 60%),
        linear-gradient(180deg, rgba(255,255,255,.98), rgba(242,245,255,.92));
    }
    .miniRemainLbl{font-size:10px; font-weight:950; letter-spacing:.35px; color: var(--muted); text-transform:uppercase}
    .miniRemainVal{font-size: 34px; font-weight: 1100; line-height: 1; letter-spacing:.3px; margin-top: 2px;}
    .miniKpis{
      margin-top: 8px;
      display:grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap:6px;
    }
    .miniKpi{
      border:1px solid rgba(10,20,40,.10);
      background: rgba(255,255,255,.88);
      border-radius: 12px;
      padding: 6px 6px;
      text-align:center;
      min-width:0;
    }
    .miniKpi .k{font-size:9px; font-weight:950; color: var(--muted); letter-spacing:.35px; text-transform:uppercase}
    .miniKpi .v{font-size:11.5px; font-weight:1100; margin-top:2px}

    .checkoutCompact{
      margin-top: 8px;
      padding-top: 8px;
      border-top:1px solid rgba(10,20,40,.10);
      font-size: 11px;
      color: var(--muted);
      line-height:1.25;
    }
    .checkoutCompact .mono{font-weight:950; color: var(--ink)}
    .checkoutCompact .lbl{font-size:9px; font-weight:950; letter-spacing:.35px; text-transform:uppercase; color: var(--muted); margin-bottom:3px}

    .actionsRow{
      display:flex;
      justify-content:flex-end;
      gap:10px;
      padding: 0 4px;
      margin-top: 0;
    }

    .entryShell{margin-top: 0; display:flex; flex-direction:column; gap:0;}
    .entryBar{
      margin-top: 0;
      border-radius: 16px;
      border:1px solid rgba(10,20,40,.12);
      background: rgba(255,255,255,.92);
      box-shadow: 0 14px 35px rgba(10,20,40,.08);
      padding: 10px 10px;
      display:flex;
      gap:8px;
      align-items:flex-end;
      flex-wrap: nowrap;
    }
    .entryBar .field{min-width: 0; flex: 1}
    .entryBar input{padding: 12px 10px}
    .entryBtn{flex: 0 0 auto}

    .scrollCard{flex: 1; overflow:auto; -webkit-overflow-scrolling: touch; padding-right: 2px;}
    .event{
      border-radius: 14px;
      border:1px solid rgba(10,20,40,.10);
      background: rgba(255,255,255,.92);
      padding: 10px 10px;
      margin-bottom: 10px;
      box-shadow: 0 10px 26px rgba(10,20,40,.06);
    }
    .event .top{display:flex; justify-content:space-between; gap:10px; align-items:center}
    .event .main{font-weight:950}
    .event .meta{font-size:12px; color: var(--muted)}

    .statsTable{
      display:grid;
      grid-template-columns: 1.4fr 1fr 1fr;
      gap:6px;
      font-size:12px;
    }
    .statsHeader{
      font-weight:1000;
      background: rgba(0,119,255,.12);
      border-radius:10px;
      padding:8px;
      text-align:center;
      border:1px solid rgba(10,20,40,.08);
    }
    .statsHeader.name{ text-align:left; }
    .statCell{
      padding:7px 8px;
      border-radius:10px;
      background: rgba(242,245,255,.8);
      border:1px solid rgba(10,20,40,.08);
    }
    .statName{ font-weight:900; color: var(--muted); }
    .statVal{ text-align:center; font-weight:1000; }
    @media (max-width: 420px){
      .statsTable{font-size:11px}
    }

    .toast{
      position: fixed; left: 50%; transform: translateX(-50%);
      bottom: 14px;
      z-index: 10000; /* above header just in case */
      background: rgba(255,255,255,.96);
      color: var(--ink);
      border:1px solid rgba(10,20,40,.16);
      border-radius: 14px;
      padding: 10px 12px;
      box-shadow: 0 18px 55px rgba(10,20,40,.15);
      display:none;
      max-width: min(760px, calc(100vw - 22px));
    }
    .toast.show{display:block}
  </style>
</head>

<body>
<header>
  <div class="brand">
    <div class="logo" aria-hidden="true"></div>
    <h1>DARTS <span>Scoreboard</span></h1>
  </div>
  <div class="btns">
    <button id="btnUndo">Undo</button>
    <button class="danger" id="btnResetAll">Reset</button>
  </div>
</header>

<main>
  <!-- Setup -->
  <section id="setupView" style="display:none; height:100%;">
    <div class="setupWrap">
      <div class="grid">
        <div class="card">
          <h2>Match setup</h2>

          <div class="grid cols3">
            <div class="field">
              <label>Starting score</label>
              <select id="startScore">
                <option value="501">501</option>
                <option value="301">301</option>
                <option value="701">701</option>
                <option value="1001">1001</option>
              </select>
            </div>
            <div class="field">
              <label>Sets to win</label>
              <input id="setsToWin" type="number" min="1" step="1" value="1" />
            </div>
            <div class="field">
              <label>Legs to win each set</label>
              <input id="legsToWin" type="number" min="1" step="1" value="3" />
            </div>
          </div>

          <div class="divider"></div>

          <div class="grid cols2">
            <div class="card" style="padding:12px;">
              <h2>Player 1</h2>
              <div class="field">
                <label>Name</label>
                <input id="p1Name" value="Player 1" />
              </div>
            </div>
            <div class="card" style="padding:12px;">
              <h2>Player 2</h2>
              <div class="field">
                <label>Name</label>
                <input id="p2Name" value="Player 2" />
              </div>
            </div>
          </div>

          <div class="divider"></div>

          <div class="row between">
            <div class="hint">Exact remaining auto-finishes the leg.</div>
            <button class="primary" id="btnStart">Start</button>
          </div>
        </div>

        <div class="card">
          <h2>Phone navigation</h2>
          <div class="hint">Swipe <b>left</b> for <b>History</b>, middle for <b>Game</b>, swipe <b>right</b> for <b>Stats</b>.</div>
        </div>
      </div>
    </div>
  </section>

  <!-- Game -->
  <section id="gameView" style="display:none; height:100%;">
    <div class="swipeShell">
      <div class="swipeHint">
        <div class="row" style="gap:8px;">
          <span class="chip">‚¨ÖÔ∏è History</span>
          <span class="chip">üéØ Game</span>
          <span class="chip">Stats ‚û°Ô∏è</span>
        </div>
        <div class="dots" aria-hidden="true">
          <span class="dot" id="dot0"></span>
          <span class="dot active" id="dot1"></span>
          <span class="dot" id="dot2"></span>
        </div>
      </div>

      <div id="swipeWrap" class="swipeWrap">
        <!-- Panel 0: HISTORY -->
        <div class="swipePanel">
          <div class="card scrollCard">
            <h2>Score history</h2>
            <div id="historyList"></div>
          </div>
        </div>

        <!-- Panel 1: GAME -->
        <div class="swipePanel">
          <div id="playersPanel" class="playerRow"></div>

          <div class="entryShell">
            <div class="entryBar">
              <div class="field">
                <label>Score</label>
                <input id="visitScore" type="number" inputmode="numeric" min="0" max="180" step="1" placeholder="e.g. 100" />
              </div>
              <div class="field" style="max-width:86px;">
                <label>Darts</label>
                <input id="visitDarts" type="number" inputmode="numeric" min="1" max="3" step="1" value="3" />
              </div>
              <div class="field" style="max-width:96px;">
                <label>Double attempts</label>
                <input id="dblAtt" type="number" inputmode="numeric" min="0" max="3" step="1" value="0" />
              </div>
              <button class="primary entryBtn" id="btnSubmit">Go</button>
            </div>
          </div>

          <div class="toast" id="toast"></div>
        </div>

        <!-- Panel 2: STATS -->
        <div class="swipePanel">
          <div class="card scrollCard">
            <h2>Statistics</h2>
            <div id="statsTable" class="statsTable"></div>
          </div>
        </div>
      </div>
    </div>
  </section>
</main>

<script>
(() => {
  const STORAGE_KEY = "darts_scoreboard_v12";
  const $ = (id) => document.getElementById(id);

  const setupView = $("setupView");
  const gameView  = $("gameView");

  const playersPanel = $("playersPanel");
  const historyList  = $("historyList");
  const toastEl = $("toast");

  const startScoreEl = $("startScore");
  const setsToWinEl  = $("setsToWin");
  const legsToWinEl  = $("legsToWin");
  const p1NameEl     = $("p1Name");
  const p2NameEl     = $("p2Name");

  const visitScoreEl = $("visitScore");
  const visitDartsEl = $("visitDarts");
  const dblAttEl     = $("dblAtt");

  const btnStart     = $("btnStart");
  const btnSubmit    = $("btnSubmit");
  const btnUndo      = $("btnUndo");
  const btnResetAll  = $("btnResetAll");

  const swipeWrap = $("swipeWrap");
  const dot0 = $("dot0"), dot1 = $("dot1"), dot2 = $("dot2");

  // ---------- Checkout suggestions (BULL) ----------
  const TARGETS = [];
  const addTarget = (code, value, isDouble=false) => TARGETS.push({code,value,isDouble});
  for (let i=1;i<=20;i++) addTarget(String(i), i, false);
  addTarget("25", 25, false);
  for (let i=1;i<=20;i++) addTarget("D"+i, i*2, true);
  addTarget("BULL", 50, true);
  for (let i=1;i<=20;i++) addTarget("T"+i, i*3, false);

  const CHECKOUTS = new Map();
  (function genCheckouts(){
    const doubles = TARGETS.filter(t => t.isDouble);
    const all = TARGETS;

    const push = (rem, combo) => {
      const s = combo.join(" ");
      if (!CHECKOUTS.has(rem)) CHECKOUTS.set(rem, []);
      const arr = CHECKOUTS.get(rem);
      if (!arr.includes(s)) arr.push(s);
    };

    for (const d of doubles){
      if (d.value >= 2 && d.value <= 170) push(d.value, [d.code]);
    }
    for (const a of all){
      for (const d of doubles){
        const rem = a.value + d.value;
        if (rem >= 2 && rem <= 170) push(rem, [a.code, d.code]);
      }
    }
    for (const a of all){
      for (const b of all){
        for (const d of doubles){
          const rem = a.value + b.value + d.value;
          if (rem >= 2 && rem <= 170) push(rem, [a.code, b.code, d.code]);
        }
      }
    }

    const val = (code) => {
      if (code === "BULL") return 50;
      if (code.startsWith("T")) return parseInt(code.slice(1),10)*3;
      if (code.startsWith("D")) return parseInt(code.slice(1),10)*2;
      return parseInt(code,10);
    };

    for (const [rem, arr] of CHECKOUTS.entries()){
      arr.sort((x,y) => {
        const ax = x.split(" "); const ay = y.split(" ");
        if (ax.length !== ay.length) return ax.length - ay.length;
        const vx = val(ax[0]); const vy = val(ay[0]);
        if (vx !== vy) return vy - vx;
        return x.localeCompare(y);
      });
    }
  })();

  // ---------- State ----------
  function emptyMatch(){
    return {
      version: 12,
      config: null,
      status: "setup",

      currentPlayer: 0,
      setNo: 1,
      legNo: 1,
      setsWon: [0,0],
      legsWonInSet: [0,0],

      legStarter: 0,
      remaining: [null, null],
      legDarts: [0,0],
      legScored: [0,0],
      legVisits: [[],[]],

      history: [],
      legs: []
    };
  }

  let match = load() ?? emptyMatch();
  function save(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(match)); }
  function load(){
    try{
      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) return null;
      return JSON.parse(raw);
    }catch(_){ return null; }
  }

  // ---------- Helpers ----------
  const nowISO = () => new Date().toISOString();
  const clampInt = (v, min, max) => {
    const n = Number(v);
    if (!Number.isFinite(n)) return null;
    const i = Math.trunc(n);
    if (i < min || i > max) return null;
    return i;
  };
  const fmt = (x, digits=2) => (typeof x === "number" && Number.isFinite(x)) ? x.toFixed(digits) : "‚Äî";
  const activeIdx = () => match.currentPlayer;
  const otherIdx = () => 1 - match.currentPlayer;

  const canCheckout = (remaining) => remaining >= 2 && remaining <= 170 && CHECKOUTS.has(remaining);
  const checkoutSuggestions = (remaining, maxLines=1) => canCheckout(remaining) ? CHECKOUTS.get(remaining).slice(0, maxLines) : [];

  function escapeHtml(s){
    return String(s)
      .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
      .replaceAll('"',"&quot;").replaceAll("'","&#039;");
  }

  function toast(msg, kind=""){
    toastEl.textContent = msg;
    toastEl.className = "toast show";
    if (kind === "bad") toastEl.style.borderColor = "rgba(239,68,68,.45)";
    else if (kind === "good") toastEl.style.borderColor = "rgba(16,185,129,.45)";
    else if (kind === "warn") toastEl.style.borderColor = "rgba(245,158,11,.55)";
    else toastEl.style.borderColor = "rgba(10,20,40,.16)";
    setTimeout(() => toastEl.className = "toast", 2000);
  }

  function focusScoreInput(){
    visitScoreEl.focus({preventScroll:true});
  }

  // ---------- Match flow ----------
  function startNewMatch(config){
    match = emptyMatch();
    match.config = config;
    match.status = "playing";

    match.currentPlayer = 0;
    match.setNo = 1;
    match.legNo = 1;
    match.setsWon = [0,0];
    match.legsWonInSet = [0,0];

    match.legStarter = 0;
    match.remaining = [config.startScore, config.startScore];
    match.legDarts = [0,0];
    match.legScored = [0,0];
    match.legVisits = [[],[]];

    match.history.push({ type:"match_start", ts: nowISO(), config });
    match.history.push({ type:"leg_start", ts: nowISO(), setNo: 1, legNo: 1, starter: 0 });

    save();
    render();
    snapToPanel(1, false);
    resetVisitInputs(true);
    toast("Match started!", "good");
  }

  function beginNextLeg(){
    match.legNo += 1;
    match.legStarter = (match.legStarter + 1) % 2;
    match.currentPlayer = match.legStarter;

    match.remaining = [match.config.startScore, match.config.startScore];
    match.legDarts = [0,0];
    match.legScored = [0,0];
    match.legVisits = [[],[]];

    match.history.push({ type:"leg_start", ts: nowISO(), setNo: match.setNo, legNo: match.legNo, starter: match.legStarter });
    save();
  }

  function beginNextSet(){
    match.setNo += 1;
    match.legNo = 1;
    match.legsWonInSet = [0,0];

    match.legStarter = (match.legStarter + 1) % 2;
    match.currentPlayer = match.legStarter;

    match.remaining = [match.config.startScore, match.config.startScore];
    match.legDarts = [0,0];
    match.legScored = [0,0];
    match.legVisits = [[],[]];

    match.history.push({ type:"set_start", ts: nowISO(), setNo: match.setNo });
    match.history.push({ type:"leg_start", ts: nowISO(), setNo: match.setNo, legNo: 1, starter: match.legStarter });
    save();
  }

  function finishMatch(winnerIdx){
    match.status = "finished";
    match.history.push({ type:"match_end", ts: nowISO(), winner: winnerIdx });
    save();
  }

  function calcFirst9(playerIdx){
    const visits = match.legVisits[playerIdx].slice(0,3);
    if (visits.length < 3) return null;
    const scored = visits.reduce((a,b)=>a+b,0);
    return (scored / 9) * 3;
  }

  function calcDoublesInLeg(){
    const att = [0,0];
    for (let i = match.history.length-1; i>=0; i--){
      const ev = match.history[i];
      if (ev.type === "leg_start") break;
      if (ev.type === "visit") att[ev.player] += ev.doubleAttempts;
    }
    return { att };
  }

  function endLeg(winnerIdx, forced=false){
    const winnerName = match.config.players[winnerIdx].name;
    const winnerDarts = match.legDarts[winnerIdx];

    const first9 = [calcFirst9(0), calcFirst9(1)];
    const doubles = calcDoublesInLeg();
    const checkoutAttempts = [doubles.att[0] > 0 ? 1 : 0, doubles.att[1] > 0 ? 1 : 0];

    match.legs.push({
      ts: nowISO(),
      setNo: match.setNo,
      legNo: match.legNo,
      starter: match.legStarter,
      winner: winnerIdx,
      forced,
      darts: [match.legDarts[0], match.legDarts[1]],
      scored: [match.legScored[0], match.legScored[1]],
      first9,
      doubles,
      checkoutAttempts
    });

    match.history.push({ type:"leg_end", ts: nowISO(), setNo: match.setNo, legNo: match.legNo, winner: winnerIdx, forced });
    match.legsWonInSet[winnerIdx] += 1;

    if (match.legsWonInSet[winnerIdx] >= match.config.legsToWin){
      match.setsWon[winnerIdx] += 1;
      match.history.push({ type:"set_end", ts: nowISO(), setNo: match.setNo, winner: winnerIdx });

      if (match.setsWon[winnerIdx] >= match.config.setsToWin){
        finishMatch(winnerIdx);
        render();
        toast(`${winnerName} wins the match!`, "good");
        return;
      }

      beginNextSet();
      render();
      const nextStarterName = match.config.players[match.legStarter].name;
      toast(`${winnerName} wins the leg in ${winnerDarts} darts. ${nextStarterName} throws first. Game on!`, "good");
      return;
    }

    beginNextLeg();
    render();
    const nextStarterName = match.config.players[match.legStarter].name;
    toast(`${winnerName} wins the leg in ${winnerDarts} darts. ${nextStarterName} throws first. Game on!`, "good");
  }

  // ---------- Scoring ----------
  function submitVisit(){
    if (match.status !== "playing") return;

    const p = activeIdx();
    const score = clampInt(visitScoreEl.value, 0, 180);
    const dartsUsed = clampInt(visitDartsEl.value, 1, 3);
    const dblAtt = clampInt(dblAttEl.value, 0, 3);

    if (score === null){ toast("Enter a valid score (0‚Äì180).", "bad"); return; }
    if (dartsUsed === null){ toast("Darts must be 1‚Äì3.", "bad"); return; }
    if (dblAtt === null){ toast("Double attempts must be 0‚Äì3.", "bad"); return; }

    const prev = match.remaining[p];
    const next = prev - score;

    let bust = false;
    let checkout = false;

    if (next < 0 || next === 1) bust = true;
    if (next === 0) checkout = true;

    match.history.push({
      type:"visit",
      ts: nowISO(),
      player: p,
      setNo: match.setNo,
      legNo: match.legNo,
      prevRemaining: prev,
      score,
      dartsUsed,
      doubleAttempts: dblAtt,
      bust,
      checkout
    });

    match.legDarts[p] += dartsUsed;

    if (bust){
      match.legVisits[p].push(0);
      save(); render();
      toast(`${match.config.players[p].name} bust!`, "bad");
      match.currentPlayer = otherIdx();
      save(); render();
      resetVisitInputs(true);
      return;
    }

    match.remaining[p] = next;
    match.legScored[p] += score;
    match.legVisits[p].push(score);

    save(); render();

    if (checkout){
      endLeg(p, false);
      resetVisitInputs(true);
      return;
    }

    match.currentPlayer = otherIdx();
    save(); render();
    resetVisitInputs(true);
  }

  function resetVisitInputs(tryFocus=false){
    visitScoreEl.value = "";
    visitDartsEl.value = "3";
    dblAttEl.value = "0";
    if (tryFocus) focusScoreInput();
  }

  // ---------- Undo ----------
  function computeLegsFromHistory(m){
    const legs = [];
    let legStartIndex = -1;
    let legStarter = 0;

    let legDarts = [0,0];
    let legScored = [0,0];
    let legVisits = [[],[]];
    let setNo = 1, legNo = 1;

    const calcFirst9 = (p) => {
      const v = legVisits[p].slice(0,3);
      if (v.length < 3) return null;
      const scored = v.reduce((a,b)=>a+b,0);
      return (scored/9)*3;
    };

    for (let i=0;i<m.history.length;i++){
      const ev = m.history[i];
      if (ev.type === "leg_start"){
        legStartIndex = i;
        setNo = ev.setNo; legNo = ev.legNo; legStarter = ev.starter;
        legDarts = [0,0]; legScored = [0,0]; legVisits = [[],[]];
      }
      if (ev.type === "visit"){
        const p = ev.player;
        legDarts[p] += ev.dartsUsed;
        if (!ev.bust){
          legScored[p] += ev.score;
          legVisits[p].push(ev.score);
        } else {
          legVisits[p].push(0);
        }
      }
      if (ev.type === "leg_end" && legStartIndex !== -1){
        const doubles = (() => {
          const att=[0,0];
          for (let j=i; j>=0; j--){
            const e2 = m.history[j];
            if (e2.type === "leg_start") break;
            if (e2.type === "visit") att[e2.player] += e2.doubleAttempts;
          }
          return {att};
        })();
        const first9 = [calcFirst9(0), calcFirst9(1)];
        const checkoutAttempts = [doubles.att[0]>0?1:0, doubles.att[1]>0?1:0];

        legs.push({
          ts: ev.ts,
          setNo, legNo, starter: legStarter,
          winner: ev.winner,
          forced: ev.forced,
          darts: [legDarts[0], legDarts[1]],
          scored: [legScored[0], legScored[1]],
          first9,
          doubles,
          checkoutAttempts
        });
        legStartIndex = -1;
      }
    }
    return legs;
  }

  function undo(){
    const lastVisitIndex = (() => {
      for (let i = match.history.length-1; i>=0; i--){
        if (match.history[i].type === "visit") return i;
      }
      return -1;
    })();
    if (lastVisitIndex === -1){ toast("Nothing to undo.", "warn"); return; }

    match.history.splice(lastVisitIndex, 1);

    const cfg = match.config;
    const rebuilt = emptyMatch();
    rebuilt.config = cfg;
    rebuilt.status = "playing";
    rebuilt.history = match.history.slice(0);

    rebuilt.currentPlayer = 0;
    rebuilt.setNo = 1;
    rebuilt.legNo = 1;
    rebuilt.setsWon = [0,0];
    rebuilt.legsWonInSet = [0,0];
    rebuilt.legStarter = 0;
    rebuilt.remaining = [cfg.startScore, cfg.startScore];
    rebuilt.legDarts = [0,0];
    rebuilt.legScored = [0,0];
    rebuilt.legVisits = [[],[]];

    for (const ev of rebuilt.history){
      if (ev.type === "leg_start"){
        rebuilt.setNo = ev.setNo;
        rebuilt.legNo = ev.legNo;
        rebuilt.legStarter = ev.starter;
        rebuilt.currentPlayer = ev.starter;
        rebuilt.remaining = [cfg.startScore, cfg.startScore];
        rebuilt.legDarts = [0,0];
        rebuilt.legScored = [0,0];
        rebuilt.legVisits = [[],[]];
      }
      if (ev.type === "visit"){
        const p = ev.player;
        rebuilt.legDarts[p] += ev.dartsUsed;
        if (ev.bust){
          rebuilt.legVisits[p].push(0);
          rebuilt.currentPlayer = 1 - p;
        } else {
          rebuilt.remaining[p] = ev.prevRemaining - ev.score;
          rebuilt.legScored[p] += ev.score;
          rebuilt.legVisits[p].push(ev.score);
          if (!ev.checkout) rebuilt.currentPlayer = 1 - p;
        }
      }
      if (ev.type === "leg_end"){
        rebuilt.legsWonInSet[ev.winner] += 1;
      }
      if (ev.type === "set_end"){
        rebuilt.setsWon[ev.winner] += 1;
        rebuilt.legsWonInSet = [0,0];
      }
      if (ev.type === "match_end"){
        rebuilt.status = "finished";
      }
    }

    rebuilt.legs = computeLegsFromHistory(rebuilt);

    match = rebuilt;
    save();
    render();
    toast("Undid last visit.", "good");
    resetVisitInputs(true);
  }

  // ---------- Stats ----------
  function buildPlayerStats(playerIdx){
    const visits = match.history.filter(e => e.type === "visit" && e.player === playerIdx);

    let totalScored = 0;
    let totalDarts = 0;
    let c60=0,c100=0,c140=0,c170=0,c180=0;
    let doubleAtt=0;

    for (const v of visits){
      totalDarts += v.dartsUsed;
      doubleAtt += v.doubleAttempts;

      const pts = v.bust ? 0 : v.score;
      totalScored += pts;

      if (pts >= 60) c60++;
      if (pts >= 100) c100++;
      if (pts >= 140) c140++;
      if (pts >= 170) c170++;
      if (pts === 180) c180++;
    }

    const matchAvg = totalDarts ? (totalScored/totalDarts)*3 : null;

    const legsAll = match.legs;
    const legsWonTotal = legsAll.filter(L => L.winner === playerIdx).length;

    const legAvgs = legsAll.map(L => {
      const d = L.darts[playerIdx];
      const s = L.scored[playerIdx];
      return d ? (s/d)*3 : null;
    }).filter(x => typeof x === "number" && Number.isFinite(x));

    const bestLegAvg = legAvgs.length ? Math.max(...legAvgs) : null;
    const worstLegAvg = legAvgs.length ? Math.min(...legAvgs) : null;

    const lastLeg = legsAll.length ? legsAll[legsAll.length - 1] : null;
    const previousLegAvg = lastLeg ? (lastLeg.darts[playerIdx] ? (lastLeg.scored[playerIdx]/lastLeg.darts[playerIdx])*3 : null) : null;
    const currentLegAvg = match.legDarts[playerIdx] ? (match.legScored[playerIdx]/match.legDarts[playerIdx])*3 : null;

    const legDartsTotal = legsAll.reduce((a,L)=>a+(L.darts[playerIdx]||0),0);
    const legScoredTotal = legsAll.reduce((a,L)=>a+(L.scored[playerIdx]||0),0);
    const completedLegAvg = legDartsTotal ? (legScoredTotal/legDartsTotal)*3 : null;

    const legsPlayed = legsAll.length;
    const avgDartsPerLeg = legsPlayed ? (legDartsTotal / legsPlayed) : null;

    const wonLegDarts = legsAll.filter(L => L.winner === playerIdx).map(L => L.darts[playerIdx]).filter(n => typeof n === "number" && n > 0);
    const bestLegDarts = wonLegDarts.length ? Math.min(...wonLegDarts) : null;

    const breaks = legsAll.filter(L => L.winner === playerIdx && L.starter !== playerIdx).length;

    const checkoutAttempts = legsAll.reduce((a,L)=>a+(L.checkoutAttempts?.[playerIdx] ? 1 : 0),0);
    const checkoutSuccess = legsAll.reduce((a,L)=>a+((L.checkoutAttempts?.[playerIdx] ? 1 : 0) && L.winner===playerIdx ? 1 : 0),0);
    const checkoutPct = checkoutAttempts ? (checkoutSuccess/checkoutAttempts)*100 : null;

    let first9Sum=0, first9Count=0;
    for (const L of legsAll){
      const f = L.first9?.[playerIdx];
      if (typeof f === "number" && Number.isFinite(f)){
        first9Sum += f;
        first9Count += 1;
      }
    }
    const first9Avg = first9Count ? (first9Sum/first9Count) : null;

    return {
      totalScored, legsWonTotal, matchAvg, completedLegAvg,
      bestLegAvg, worstLegAvg, previousLegAvg, currentLegAvg,
      checkoutPct,
      doubleAtt,
      breaks, avgDartsPerLeg, bestLegDarts,
      first9Avg, c60,c100,c140,c170,c180
    };
  }

  // ---------- Render ----------
  function renderPlayers(){
    playersPanel.innerHTML = "";
    for (let i=0;i<2;i++){
      const isActive = i === match.currentPlayer && match.status === "playing";
      const rem = match.remaining[i];
      const sug = checkoutSuggestions(rem, 1);
      const currentLegAvg = match.legDarts[i] ? (match.legScored[i]/match.legDarts[i])*3 : null;

      const dartsThisLeg = match.legDarts[i] ?? 0;

      const el = document.createElement("div");
      el.className = "playerMini";
      el.innerHTML = `
        <div class="miniTop">
          <div class="miniName">${escapeHtml(match.config.players[i].name)} <span>(${dartsThisLeg})</span></div>
          <div class="turnPill">${isActive ? `<span class="turnDot"></span> TURN` : `&nbsp;`}</div>
        </div>
        <div class="miniBody">
          <div class="miniRemainLbl">Remaining</div>
          <div class="miniRemainVal">${rem}</div>

          <div class="miniKpis">
            <div class="miniKpi"><div class="k">SETS</div><div class="v">${match.setsWon[i]}</div></div>
            <div class="miniKpi"><div class="k">LEGS</div><div class="v">${match.legsWonInSet[i]}</div></div>
            <div class="miniKpi"><div class="k">AVG</div><div class="v">${fmt(currentLegAvg)}</div></div>
          </div>

          <div class="checkoutCompact">
            <div class="lbl">Checkout</div>
            ${sug.length ? `<div class="mono">${rem}: ${escapeHtml(sug[0])}</div>` : `<div>‚Äî</div>`}
          </div>
        </div>
      `;
      playersPanel.appendChild(el);
    }
  }

  function renderHistory(){
    const events = match.history.slice().reverse().filter(e =>
      ["visit","leg_end","set_end","match_end","match_start"].includes(e.type)
    ).slice(0, 200);

    historyList.innerHTML = "";
    if (!events.length){
      historyList.innerHTML = `<div class="hint">No history yet.</div>`;
      return;
    }

    for (const ev of events){
      const div = document.createElement("div");
      div.className = "event";

      if (ev.type === "visit"){
        const name = match.config.players[ev.player].name;
        const label = ev.checkout ? "CHECKOUT" : ev.bust ? "BUST" : "VISIT";
        const after = ev.bust ? ev.prevRemaining : (ev.prevRemaining - ev.score);

        div.innerHTML = `
          <div class="top">
            <div class="main">${escapeHtml(name)}: ${ev.score} <span class="meta">(${label})</span></div>
            <div class="meta">S${ev.setNo} L${ev.legNo}</div>
          </div>
          <div class="meta">Remaining: ${ev.prevRemaining} ‚Üí ${after} ¬∑ Darts: ${ev.dartsUsed} ¬∑ Double att: ${ev.doubleAttempts}</div>
        `;
      } else if (ev.type === "leg_end"){
        const name = match.config.players[ev.winner].name;
        div.innerHTML = `
          <div class="top">
            <div class="main">Leg won by ${escapeHtml(name)}</div>
            <div class="meta">S${ev.setNo} L${ev.legNo}</div>
          </div>
        `;
      } else if (ev.type === "set_end"){
        const name = match.config.players[ev.winner].name;
        div.innerHTML = `
          <div class="top">
            <div class="main">Set ${ev.setNo} won by ${escapeHtml(name)}</div>
            <div class="meta">‚Äî</div>
          </div>
        `;
      } else if (ev.type === "match_start"){
        div.innerHTML = `
          <div class="top">
            <div class="main">Match started</div>
            <div class="meta">Start ${ev.config.startScore}</div>
          </div>
          <div class="meta">${escapeHtml(ev.config.players[0].name)} vs ${escapeHtml(ev.config.players[1].name)} ¬∑ First to ${ev.config.setsToWin} set(s), ${ev.config.legsToWin} leg(s)</div>
        `;
      } else if (ev.type === "match_end"){
        const name = match.config.players[ev.winner].name;
        div.innerHTML = `
          <div class="top">
            <div class="main">Match won by ${escapeHtml(name)}</div>
            <div class="meta">Final</div>
          </div>
        `;
      }

      historyList.appendChild(div);
    }
  }

  function renderStats(){
    const s0 = buildPlayerStats(0);
    const s1 = buildPlayerStats(1);

    const p0 = match.config.players[0].name;
    const p1 = match.config.players[1].name;

    const fmtPct = (v) => v == null ? "‚Äî" : `${v.toFixed(1)}%`;
    const fmtNum = (v) => v == null ? "‚Äî" : v.toFixed(2);

    const rows = [
      ["Score", s0.totalScored, s1.totalScored],
      ["Legs won (total)", s0.legsWonTotal, s1.legsWonTotal],
      ["Match average", fmtNum(s0.matchAvg), fmtNum(s1.matchAvg)],
      ["Leg average", fmtNum(s0.completedLegAvg), fmtNum(s1.completedLegAvg)],
      ["Best leg avg", fmtNum(s0.bestLegAvg), fmtNum(s1.bestLegAvg)],
      ["Worst leg avg", fmtNum(s0.worstLegAvg), fmtNum(s1.worstLegAvg)],
      ["Previous leg avg", fmtNum(s0.previousLegAvg), fmtNum(s1.previousLegAvg)],
      ["Current leg avg", fmtNum(s0.currentLegAvg), fmtNum(s1.currentLegAvg)],
      ["Checkout %", fmtPct(s0.checkoutPct), fmtPct(s1.checkoutPct)],
      ["Double attempts", s0.doubleAtt, s1.doubleAtt],
      ["Breaks", s0.breaks, s1.breaks],
      ["Avg darts / leg", fmtNum(s0.avgDartsPerLeg), fmtNum(s1.avgDartsPerLeg)],
      ["Best leg darts", s0.bestLegDarts ?? "‚Äî", s1.bestLegDarts ?? "‚Äî"],
      ["First 9 avg", fmtNum(s0.first9Avg), fmtNum(s1.first9Avg)],
      ["60+ / 100+ / 140+", `${s0.c60}/${s0.c100}/${s0.c140}`, `${s1.c60}/${s1.c100}/${s1.c140}`],
      ["170+ / 180s", `${s0.c170}/${s0.c180}`, `${s1.c170}/${s1.c180}`]
    ];

    let html = `
      <div class="statsHeader name">Statistic</div>
      <div class="statsHeader">${escapeHtml(p0)}</div>
      <div class="statsHeader">${escapeHtml(p1)}</div>
    `;

    for (const [name, v0, v1] of rows){
      html += `
        <div class="statCell statName">${escapeHtml(name)}</div>
        <div class="statCell statVal">${escapeHtml(v0)}</div>
        <div class="statCell statVal">${escapeHtml(v1)}</div>
      `;
    }

    $("statsTable").innerHTML = html;
  }

  function render(){
    if (!match || match.status === "setup" || !match.config){
      setupView.style.display = "block";
      gameView.style.display = "none";
      return;
    }
    setupView.style.display = "none";
    gameView.style.display = "block";

    renderPlayers();
    renderHistory();
    renderStats();

    btnUndo.disabled = (match.status !== "playing") || !match.history.some(e => e.type === "visit");
  }

  // ---------- Swipe dots ----------
  function updateDots(){
    const x = swipeWrap.scrollLeft;
    const w = swipeWrap.clientWidth || 1;
    const idx = Math.round(x / w);
    dot0.classList.toggle("active", idx === 0);
    dot1.classList.toggle("active", idx === 1);
    dot2.classList.toggle("active", idx === 2);
  }
  function snapToPanel(index, smooth=true){
    const w = swipeWrap.clientWidth || 1;
    swipeWrap.scrollTo({ left: index * w, behavior: smooth ? "smooth" : "instant" });
  }
  swipeWrap.addEventListener("scroll", updateDots, {passive:true});
  window.addEventListener("resize", () => {
    const w = swipeWrap.clientWidth || 1;
    const idx = Math.round(swipeWrap.scrollLeft / w);
    snapToPanel(idx, false);
    updateDots();
  });

  // ---------- UI actions ----------
  btnStart.addEventListener("click", () => {
    const startScore = clampInt(startScoreEl.value, 101, 5000) ?? 501;
    const setsToWin = clampInt(setsToWinEl.value, 1, 99);
    const legsToWin = clampInt(legsToWinEl.value, 1, 99);
    const p1 = (p1NameEl.value || "Player 1").trim();
    const p2 = (p2NameEl.value || "Player 2").trim();

    if (!setsToWin || !legsToWin) { toast("Sets/legs must be >= 1.", "bad"); return; }
    if (!p1 || !p2) { toast("Enter both player names.", "bad"); return; }

    startNewMatch({ startScore, setsToWin, legsToWin, players:[{name:p1},{name:p2}] });
  });

  btnSubmit.addEventListener("click", () => { submitVisit(); focusScoreInput(); });
  visitScoreEl.addEventListener("keydown", (e) => {
    if (e.key === "Enter"){ submitVisit(); focusScoreInput(); }
  });

  btnUndo.addEventListener("click", () => { undo(); focusScoreInput(); });

  btnResetAll.addEventListener("click", () => {
    localStorage.removeItem(STORAGE_KEY);
    match = emptyMatch();
    match.status = "setup";
    render();
    toast("Storage cleared.", "good");
  });

  // ---------- Boot ----------
  if (!match || !match.config || match.status === "setup"){
    match = match ?? emptyMatch();
    match.status = "setup";
  }
  match.legs = match.legs?.length ? match.legs : computeLegsFromHistory(match);

  render();
  if (match.status !== "setup" && match.config){
    snapToPanel(1, false);
    setTimeout(() => focusScoreInput(), 60);
  }
})();
</script>
</body>
</html>
